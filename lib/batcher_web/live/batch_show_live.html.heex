<Layouts.app flash={@flash}>
  <div class="space-y-6">
    <.breadcrumb items={[{"Batches", "/"}, {"Batch #{@batch.id}", ~p"/batches/#{@batch.id}"}]} />

    <div class="flex flex-col lg:flex-row gap-6">
      <%!-- Main content --%>
      <div class="flex-1 space-y-6">
        <%!-- Batch info card --%>
        <div class="space-y-4">
          <div class="flex items-center gap-3">
            <h1 class="text-xl font-semibold">Batch {@batch.id}</h1>
            <.status_badge status={@batch.state} />
          </div>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
              <div class="text-base-content/50 mb-1">Model</div>
              <div class="font-mono">{@batch.model}</div>
            </div>
            <div>
              <div class="text-base-content/50 mb-1">Endpoint</div>
              <div class="font-mono text-base-content/70">{@batch.url}</div>
            </div>
            <div>
              <div class="text-base-content/50 mb-1">Created</div>
              <div>{Calendar.strftime(@batch.created_at, "%d %b %Y, %H:%M")}</div>
            </div>
            <div>
              <div class="text-base-content/50 mb-1">Requests</div>
              <div class="font-medium">{@total_count}</div>
            </div>
          </div>

          <div :if={@batch.error_msg} class="text-sm text-error bg-error/10 px-3 py-2 rounded">
            {@batch.error_msg}
          </div>

          <div class="flex gap-2 pt-2">
            <button
              :if={
                @batch.state != :cancelled and @batch.state != :done and @batch.state != :failed
              }
              phx-click="cancel_batch"
              class="btn btn-sm btn-ghost text-warning"
              data-confirm="Are you sure you want to cancel this batch?"
            >
              Cancel
            </button>
            <button
              :if={@batch.state == :cancelled or @batch.state == :done or @batch.state == :failed}
              phx-click="delete_batch"
              class="btn btn-sm btn-ghost text-error"
              data-confirm="Are you sure you want to delete this batch?"
            >
              Delete
            </button>
          </div>
        </div>

        <%!-- Requests table --%>
        <div class="border border-base-300/50 rounded-lg overflow-hidden">
          <div class="px-4 py-3 border-b border-base-300/50 bg-base-200/30">
            <span class="font-medium">Requests</span>
          </div>

          <%= if @total_count == 0 do %>
            <div class="p-8 text-center text-base-content/50">
              No requests in this batch
            </div>
          <% else %>
            <.table id="requests" rows={@streams.requests}>
              <:col :let={{_id, request}} label="Custom ID">
                <.link
                  navigate={~p"/requests/#{request.id}"}
                  class="text-primary hover:underline font-mono text-sm"
                >
                  {request.custom_id}
                </.link>
              </:col>
              <:col :let={{_id, request}} label="Status">
                <.status_badge status={request.state} />
              </:col>
              <:col :let={{_id, request}} label="Delivery">
                <.delivery_config_display config={request.delivery_config} />
              </:col>
              <:col :let={{_id, request}} label="Created">
                <span class="text-xs text-base-content/50">
                  {Calendar.strftime(request.created_at, "%H:%M:%S")}
                </span>
              </:col>
            </.table>

            <div class="px-4 py-3 border-t border-base-300/50">
              <.pagination_controls
                page={@page}
                per_page={@per_page}
                total_count={@total_count}
                phx_click="paginate_requests"
              />
            </div>
          <% end %>
        </div>
      </div>

      <%!-- Sidebar --%>
      <div class="w-full lg:w-72 space-y-4">
        <div class="border border-base-300/50 rounded-lg p-4 space-y-4">
          <div class="text-sm font-medium text-base-content/50 uppercase tracking-wider">
            OpenAI
          </div>
          <div class="space-y-3 text-sm">
            <div>
              <div class="text-base-content/50">Batch ID</div>
              <div class="font-mono text-xs break-all">{@batch.openai_batch_id || "—"}</div>
            </div>
            <div>
              <div class="text-base-content/50">Input file</div>
              <div class="font-mono text-xs break-all text-base-content/70">
                {@batch.openai_input_file_id || "—"}
              </div>
            </div>
            <div>
              <div class="text-base-content/50">Output file</div>
              <div class="font-mono text-xs break-all text-base-content/70">
                {@batch.openai_output_file_id || "—"}
              </div>
            </div>
          </div>
        </div>

        <div class="border border-base-300/50 rounded-lg p-4 space-y-4">
          <div class="text-sm font-medium text-base-content/50 uppercase tracking-wider">
            Token usage
          </div>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-base-content/60">Input</span>
              <span class="font-mono">{@batch.input_tokens || 0}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-base-content/60">Cached</span>
              <span class="font-mono">{@batch.cached_tokens || 0}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-base-content/60">Output</span>
              <span class="font-mono">{@batch.output_tokens || 0}</span>
            </div>
            <div class="flex justify-between pt-2 border-t border-base-300/50 font-medium">
              <span>Total</span>
              <span class="font-mono">
                {(@batch.input_tokens || 0) + (@batch.output_tokens || 0)}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layouts.app>
