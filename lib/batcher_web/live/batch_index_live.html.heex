<Layouts.app flash={@flash} current_path={@current_path} rabbitmq_connected={@rabbitmq_connected}>
  <div class="flex flex-col h-full">
    <!-- Header - fixed height -->
    <div class="flex items-center pb-4 shrink-0">
      <div class="flex-1 flex items-center ">
        <div class="shrink-0">
          <h1 class="text-2xl font-bold">Batches</h1>
          <p class="text-sm text-base-content/60 mt-1">Manage your batches</p>
        </div>
      </div>
      <.search_box query={@query_text} />
      <div class="flex-1 flex items-center justify-end gap-3">
        <.sort_changer selected={@sort_by} />
      </div>
    </div>
    
<!-- Table container - takes remaining space -->
    <div class="flex-1 flex flex-col min-h-0">
      <div class="flex-1 min-h-0 border border-base-300/50 rounded-lg overflow-hidden">
        <%= if @page.results==[] do %>
          <div class="h-full flex items-center justify-center">
            <div class="text-center">
              <.icon name="batch-icon" class="w-10 h-10 mx-auto text-base-content/20 mb-3" />
              <div class="text-base-content/50">No batches found</div>
            </div>
          </div>
        <% else %>
          <!-- Scrollable table area -->
          <div class="h-full overflow-auto">
            <.table
              id="batches"
              rows={@page.results}
              row_navigate={fn batch -> ~p"/batches/#{batch.id}" end}
              class="min-w-[1550px]"
            >
              <:col :let={batch} label="ID" width="w-20">
                <span class="font-mono text-sm">{batch.id}</span>
              </:col>
              <:col :let={batch} label="Endpoint" width="w-32">
                <span class="font-mono text-sm truncate block">{batch.url}</span>
              </:col>
              <:col :let={batch} label="Model" width="w-44">
                <span class="font-mono text-sm truncate block">{batch.model}</span>
              </:col>
              <:col :let={batch} label="Requests" width="w-24">
                {batch.request_count || 0}
              </:col>
              <:col :let={batch} label="Size" width="w-24">
                {Format.bytes(batch.size_bytes)}
              </:col>
              <:col :let={batch} label="Est. tokens" width="w-24">
                <span class="font-mono text-sm">
                  {Format.compact_number(batch.estimated_request_input_tokens_total || 0)}
                </span>
              </:col>
              <:col :let={batch} label="Status" width="w-32">
                <div class="flex items-center gap-2">
                  <.status_badge status={batch.state} />
                  <span
                    :if={token_limit_backoff_waiting?(batch)}
                    class="badge badge-warning badge-outline badge-xs"
                    title={token_limit_next_retry_title(batch.token_limit_retry_next_at)}
                  >
                    Backoff {batch.token_limit_retry_attempts || 0}/5
                  </span>
                </div>
              </:col>
              <:col :let={batch} label="Time in state" width="w-28">
                <span
                  :if={
                    batch.state in [
                      :openai_processing,
                      :waiting_for_capacity,
                      :uploading,
                      :downloading,
                      :delivering
                    ]
                  }
                  class={[
                    "text-xs text-base-content/50",
                    if(batch.openai_status_last_checked_at, do: "tooltip tooltip-bottom")
                  ]}
                  data-tip={
                    if batch.openai_status_last_checked_at do
                      "Last checked at #{Format.time_ago(batch.openai_status_last_checked_at)}"
                    end
                  }
                >
                  {status_duration(batch, @processing_since_by_batch_id)}
                </span>
              </:col>
              <:col :let={batch} label="Created" width="w-40">
                <span
                  id={"batch-created-#{batch.id}"}
                  class="text-sm text-base-content/50"
                  phx-hook="LocalTime"
                  data-utc={DateTime.to_iso8601(batch.created_at)}
                  data-format="time-ago-tooltip"
                  title={Calendar.strftime(batch.created_at, "%d/%m/%Y, %H:%M")}
                >
                  {Format.time_ago(batch.created_at)}
                </span>
              </:col>
              <:action :let={batch}>
                <div class="flex items-center justify-end gap-2">
                  <% upload_pending = pending_action?(@pending_actions, :upload, batch.id) %>
                  <% redeliver_pending = pending_action?(@pending_actions, :redeliver, batch.id) %>
                  <% restart_pending = pending_action?(@pending_actions, :restart, batch.id) %>
                  <% cancel_pending = pending_action?(@pending_actions, :cancel, batch.id) %>
                  <% delete_pending = pending_action?(@pending_actions, :delete, batch.id) %>
                  <button
                    :if={batch.state == :building and batch.request_count > 0}
                    id={"upload-batch-#{batch.id}"}
                    phx-click="upload_batch"
                    phx-value-id={batch.id}
                    class="btn btn-sm btn-primary"
                    disabled={upload_pending}
                  >
                    <%= if upload_pending do %>
                      <.icon name="hero-arrow-path" class="w-4 h-4 animate-spin" /> Uploading...
                    <% else %>
                      <.icon name="hero-arrow-up-tray" class="w-4 h-4" /> Upload
                    <% end %>
                  </button>
                  <div
                    :if={batch.state in [:partially_delivered, :delivery_failed]}
                    class="tooltip tooltip-left"
                    data-tip="Redeliver all failed requests"
                  >
                    <button
                      id={"redeliver-batch-#{batch.id}"}
                      phx-click="redeliver_batch"
                      phx-value-id={batch.id}
                      class="btn btn-sm btn-primary"
                      data-confirm="Redeliver all failed requests in this batch?"
                      disabled={redeliver_pending}
                    >
                      <%= if redeliver_pending do %>
                        <.icon name="hero-arrow-path" class="w-4 h-4 animate-spin" />
                        Redelivering...
                      <% else %>
                        <.icon name="hero-arrow-path" class="w-4 h-4" /> Redeliver
                      <% end %>
                    </button>
                  </div>
                  <button
                    :if={batch.state == :failed}
                    id={"restart-batch-#{batch.id}"}
                    phx-click="restart_batch"
                    phx-value-id={batch.id}
                    class="btn btn-sm btn-primary"
                    data-confirm="Restart this failed batch?"
                    disabled={restart_pending}
                  >
                    <%= if restart_pending do %>
                      <.icon name="hero-arrow-path" class="w-4 h-4 animate-spin" /> Restarting...
                    <% else %>
                      <.icon name="hero-arrow-path" class="w-4 h-4" /> Restart
                    <% end %>
                  </button>
                  <button
                    :if={
                      batch.state not in [
                        :done,
                        :failed,
                        :cancelled,
                        :delivered,
                        :partially_delivered,
                        :delivery_failed
                      ]
                    }
                    id={"cancel-batch-#{batch.id}"}
                    phx-click="cancel_batch"
                    phx-value-id={batch.id}
                    class="btn btn-sm btn-soft btn-warning"
                    data-confirm="Cancel this batch?"
                    disabled={cancel_pending}
                  >
                    <%= if cancel_pending do %>
                      <.icon name="hero-arrow-path" class="w-4 h-4 animate-spin" /> Cancelling...
                    <% else %>
                      <.icon name="hero-x-circle" class="w-4 h-4" /> Cancel
                    <% end %>
                  </button>
                  <.delete_batch_button
                    batch_id={batch.id}
                    batch_state={batch.state}
                    id={"delete-batch-#{batch.id}"}
                    class="btn btn-sm btn-soft btn-error"
                    label="Delete"
                    loading={delete_pending}
                    loading_label="Deleting..."
                  />
                </div>
              </:action>
            </.table>
          </div>
        <% end %>
      </div>
      
<!-- Pagination - always at bottom -->
      <div class="mt-4 shrink-0">
        <div
          :if={
            loading_processing_since?(@processing_since_status) and
              @processing_since_status != :loading_initial
          }
          class="text-xs text-base-content/60 mb-2 flex items-center gap-1"
        >
          <.icon name="hero-arrow-path" class="w-3 h-3 animate-spin" />
          Refreshing time-in-state...
        </div>
        <.async_count_pagination
          page={@page}
          page_count_status={@page_count_status}
          page_total_count={@page_total_count}
          base_path="/batches"
          extra_params={[q: @query_text, sort_by: @sort_by]}
        />
      </div>
    </div>
  </div>
</Layouts.app>
