<Layouts.app flash={@flash} current_path={@current_path}>
  <div class="max-w-6xl mx-auto space-y-6">
    <.breadcrumb items={[
      {"Requests", ~p"/requests"},
      {@request.custom_id, ~p"/requests/#{@request.id}"}
    ]} />

    <%!-- Page header --%>
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <h1 class="text-xl font-semibold font-mono">{@request.custom_id}</h1>
        <.status_badge status={@request.state} type={:request} />
      </div>
      <button
        :if={@request.batch.state == :building}
        type="button"
        class="btn btn-error btn-sm"
        phx-click="delete_request"
        data-confirm="Are you sure you want to delete this request?"
      >
        <.icon name="hero-trash" class="w-4 h-4" /> Delete
      </button>
    </div>

    <%!-- Request info --%>
    <div class="space-y-4">
      <%!-- Request Details Section --%>
      <div class="border border-base-300/50 rounded-lg overflow-hidden">
        <div class="px-4 py-3 border-b border-base-300/50 bg-base-200/30">
          <span class="font-medium">Request details</span>
        </div>
        <div class="p-4">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-3 text-sm">
            <div>
              <div class="text-base-content/50 mb-1">Batch</div>
              <.link
                navigate={~p"/batches/#{@request.batch_id}"}
                class="text-primary hover:underline"
              >
                #{@request.batch_id}
              </.link>
            </div>
            <div>
              <div class="text-base-content/50 mb-1">Model</div>
              <div class="font-mono">{@request.model}</div>
            </div>
            <div>
              <div class="text-base-content/50 mb-1">Endpoint</div>
              <div class="font-mono">{@request.url}</div>
            </div>
            <div>
              <div class="text-base-content/50 mb-1">Payload size</div>
              <div>{format_bytes(@request.request_payload_size)}</div>
            </div>
            <div>
              <div class="text-base-content/50 mb-1">Created</div>
              <div>{Calendar.strftime(@request.created_at, "%d %b %Y, %H:%M")}</div>
            </div>
            <div>
              <div class="text-base-content/50 mb-1">Updated</div>
              <div>{Calendar.strftime(@request.updated_at, "%d %b %Y, %H:%M")}</div>
            </div>
          </div>
        </div>
      </div>

      <%!-- Delivery Configuration Section --%>
      <div class="border border-base-300/50 rounded-lg overflow-hidden">
        <div class="px-4 py-3 border-b border-base-300/50 bg-base-200/30 flex items-center justify-between">
          <span class="font-medium">Delivery configuration</span>
          <button type="button" class="btn btn-ghost btn-xs" phx-click="edit_delivery_config">
            <.icon name="hero-pencil-square" class="w-4 h-4" /> Edit
          </button>
        </div>
        <div class="p-4">
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
              <div class="text-base-content/50 mb-1">Type</div>
              <div class="font-mono">{delivery_type(@request.delivery_config)}</div>
            </div>
            <div>
              <div class="text-base-content/50 mb-1">Destination</div>
              <div
                class="font-mono truncate"
                title={delivery_destination(@request.delivery_config)}
              >
                {delivery_destination(@request.delivery_config)}
              </div>
            </div>
            <%= if current_rabbitmq_exchange(@request.delivery_config) != "" do %>
              <div>
                <div class="text-base-content/50 mb-1">Exchange</div>
                <div class="font-mono">{current_rabbitmq_exchange(@request.delivery_config)}</div>
              </div>
              <div>
                <div class="text-base-content/50 mb-1">Routing Key</div>
                <div class="font-mono">
                  {current_rabbitmq_routing_key(@request.delivery_config)}
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <div
        :if={@request.error_msg}
        class="text-sm text-error bg-error/10 px-3 py-2 rounded cursor-pointer hover:bg-error/20 transition-colors flex items-center gap-2"
        phx-click="show_error_msg"
      >
        <span class="truncate flex-1">{@request.error_msg}</span>
        <.icon name="hero-arrows-pointing-out" class="w-4 h-4 shrink-0 opacity-50" />
      </div>
    </div>

    <%!-- Payloads - horizontally aligned --%>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <%!-- Request Payload Card --%>
      <div
        class="border border-base-300/50 rounded-lg overflow-hidden cursor-pointer hover:border-primary/50 transition-colors"
        phx-click="show_request_payload"
      >
        <div class="px-4 py-3 border-b border-base-300/50 bg-base-200/30 flex items-center justify-between">
          <span class="font-medium">Request payload</span>
          <.icon name="hero-arrows-pointing-out" class="w-4 h-4 text-base-content/50" />
        </div>
        <div class="p-4">
          <pre
            id="request-payload-preview"
            class="text-xs font-mono leading-relaxed overflow-hidden max-h-48 whitespace-pre-wrap break-all json-syntax"
            phx-hook="JsonSyntaxHighlight"
          >{format_json(@request.request_payload)}</pre>
          <div class="mt-2 text-xs text-primary">Click to expand</div>
        </div>
      </div>

      <%!-- Response Payload Card (if available) --%>
      <div
        :if={@request.response_payload}
        class="border border-base-300/50 rounded-lg overflow-hidden cursor-pointer hover:border-primary/50 transition-colors"
        phx-click="show_response_payload"
      >
        <div class="px-4 py-3 border-b border-base-300/50 bg-base-200/30 flex items-center justify-between">
          <span class="font-medium">Response payload</span>
          <.icon name="hero-arrows-pointing-out" class="w-4 h-4 text-base-content/50" />
        </div>
        <div class="p-4">
          <pre
            id="response-payload-preview"
            class="text-xs font-mono leading-relaxed overflow-hidden max-h-48 whitespace-pre-wrap break-all json-syntax"
            phx-hook="JsonSyntaxHighlight"
          >{format_json(@request.response_payload)}</pre>
          <div class="mt-2 text-xs text-primary">Click to expand</div>
        </div>
      </div>
    </div>

    <%!-- Delivery attempts --%>
    <div class="border border-base-300/50 rounded-lg overflow-hidden">
      <div class="px-4 py-3 border-b border-base-300/50 bg-base-200/30 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="font-medium">Delivery attempts</span>
          <span class="text-sm text-base-content/50">{@delivery_attempts_page.count || 0}</span>
        </div>
        <div class="flex items-center gap-2">
          <button
            :if={@request.state == :delivering}
            type="button"
            class="btn btn-sm btn-primary btn-disabled"
            disabled
          >
            <span class="loading loading-spinner loading-xs"></span> Delivering...
          </button>
          <div
            :if={@request.state in [:openai_processed, :delivered, :delivery_failed]}
            class="tooltip tooltip-left"
            data-tip="Redeliver with current delivery config"
          >
            <button
              type="button"
              class="btn btn-sm btn-primary"
              phx-click="retry_delivery"
              phx-disable-with="Redelivering..."
            >
              <.icon name="hero-arrow-path" class="w-4 h-4" /> Redeliver
            </button>
          </div>
        </div>
      </div>

      <%= if (@delivery_attempts_page.count || 0) == 0 do %>
        <div class="p-8 text-center text-base-content/50">
          No delivery attempts yet
        </div>
      <% else %>
        <.table id="delivery_attempts" rows={@streams.delivery_attempts}>
          <:col :let={{_id, attempt}} label="ID" width="w-1/12">
            <span class="font-mono text-xs text-base-content/50">{attempt.id}</span>
          </:col>
          <:col :let={{_id, attempt}} label="Delivery" width="w-2/12">
            <button
              type="button"
              class="hover:opacity-80 transition-opacity cursor-pointer"
              phx-click="show_attempt_delivery_config"
              phx-value-config={Jason.encode!(attempt.delivery_config)}
              title="Click to view delivery config"
            >
              <.delivery_config_display config={attempt.delivery_config} />
            </button>
          </:col>
          <:col :let={{_id, attempt}} label="Outcome" width="w-2/12">
            <%= if attempt.outcome == :success do %>
              <.status_badge status={:delivered} type={:request} />
            <% else %>
              <.status_badge status={:delivery_failed} type={:request} />
            <% end %>
          </:col>
          <:col :let={{_id, attempt}} label="Error" width="w-5/12">
            <%= if attempt.error_msg do %>
              <button
                type="button"
                class="text-xs text-error hover:text-error/80 transition-colors cursor-pointer flex items-center gap-1 w-full"
                phx-click="show_attempt_error"
                phx-value-error={attempt.error_msg}
                title="Click to view full error"
              >
                <span class="truncate">{attempt.error_msg}</span>
                <.icon name="hero-arrows-pointing-out" class="w-3 h-3 shrink-0 opacity-50" />
              </button>
            <% else %>
              <span class="text-xs text-base-content/50">—</span>
            <% end %>
          </:col>
          <:col :let={{_id, attempt}} label="Time" width="w-1/12">
            <span class="text-xs text-base-content/50">
              <%= if attempt.attempted_at do %>
                {Calendar.strftime(attempt.attempted_at, "%H:%M:%S")}
              <% else %>
                —
              <% end %>
            </span>
          </:col>
        </.table>
      <% end %>
    </div>

    <%!-- Delivery attempts pagination --%>
    <.numbered_pagination
      page={@delivery_attempts_page}
      base_path={~p"/requests/#{@request.id}"}
      extra_params={[]}
    />
  </div>

  <%!-- Payload Modal --%>
  <div
    :if={@show_payload_modal}
    class="fixed inset-0 z-50 flex items-center justify-center p-4"
  >
    <%!-- Backdrop - only this closes the modal --%>
    <div class="absolute inset-0 bg-black/50" phx-click="close_payload_modal"></div>

    <%!-- Modal Content - clicks here don't close --%>
    <div class="relative bg-base-100 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
      <%!-- Header --%>
      <div class="px-6 py-4 border-b border-base-300 flex items-center justify-between shrink-0">
        <h3 class="text-lg font-semibold">{@payload_modal_title}</h3>
        <button
          type="button"
          class="btn btn-ghost btn-sm btn-circle"
          phx-click="close_payload_modal"
        >
          <.icon name="hero-x-mark" class="w-5 h-5" />
        </button>
      </div>

      <%!-- Body --%>
      <div class="p-6 overflow-auto flex-1">
        <%= if @payload_modal_is_json do %>
          <pre
            id={"payload-modal-#{@payload_modal_title}"}
            class="text-sm font-mono leading-relaxed whitespace-pre-wrap break-all json-syntax"
            phx-hook="JsonSyntaxHighlight"
          >{@payload_modal_content}</pre>
        <% else %>
          <pre class="text-sm font-mono leading-relaxed whitespace-pre-wrap break-all">{@payload_modal_content}</pre>
        <% end %>
      </div>
    </div>
  </div>

  <%!-- Delivery Config Edit Modal --%>
  <div
    :if={@editing_delivery_config}
    class="fixed inset-0 z-50 flex items-center justify-center p-4"
  >
    <div class="absolute inset-0 bg-black/50" phx-click="cancel_edit_delivery_config"></div>

    <div class="relative bg-base-100 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
      <div class="px-6 py-4 border-b border-base-300 flex items-center justify-between shrink-0">
        <h3 class="text-lg font-semibold">Edit Delivery Configuration</h3>
        <button
          type="button"
          class="btn btn-ghost btn-sm btn-circle"
          phx-click="cancel_edit_delivery_config"
        >
          <.icon name="hero-x-mark" class="w-5 h-5" />
        </button>
      </div>

      <div class="p-6 overflow-auto flex-1">
        <.form
          for={@delivery_config_form}
          phx-change="validate_delivery_config"
          phx-submit="save_delivery_config"
          class="space-y-4"
        >
          <div>
            <label class="label mb-1">
              <span class="label-text">Delivery type</span>
            </label>
            <select
              name="form[delivery_type]"
              class="select select-bordered w-full"
            >
              <option value="">Select delivery type</option>
              <%= for {label, value} <- @delivery_types do %>
                <option value={value} selected={@selected_delivery_type == value}>
                  {label}
                </option>
              <% end %>
            </select>
          </div>

          <%!-- Webhook fields --%>
          <div :if={@selected_delivery_type == "webhook"} class="space-y-4">
            <div>
              <label class="label mb-1">
                <span class="label-text">
                  Webhook URL <span class="text-error">*</span>
                </span>
              </label>
              <input
                type="url"
                name="form[webhook_url]"
                value={@form_webhook_url}
                placeholder="https://example.com/webhook"
                class="input input-bordered w-full"
              />
            </div>
          </div>

          <%!-- RabbitMQ fields --%>
          <div :if={@selected_delivery_type == "rabbitmq"} class="space-y-4">
            <div>
              <label class="label mb-1">
                <span class="label-text">Exchange Mode</span>
              </label>
              <select name="form[rabbitmq_mode]" class="select select-bordered w-full">
                <option value="queue" selected={@form_rabbitmq_mode == "queue"}>
                  Default Exchange (publish directly to queue)
                </option>
                <option value="exchange" selected={@form_rabbitmq_mode == "exchange"}>
                  Custom Exchange (publish to exchange with routing key)
                </option>
              </select>
            </div>

            <%!-- Default exchange mode: queue only --%>
            <div :if={@form_rabbitmq_mode == "queue"}>
              <label class="label mb-1">
                <span class="label-text">
                  Queue <span class="text-error">*</span>
                </span>
              </label>
              <input
                type="text"
                name="form[rabbitmq_queue]"
                value={@form_rabbitmq_queue}
                placeholder="queue_name"
                class="input input-bordered w-full"
              />
              <p class="text-xs text-base-content/50 mt-1">
                Message will be published directly to this queue via the default exchange.
              </p>
            </div>

            <%!-- Custom exchange mode: exchange + routing key --%>
            <div :if={@form_rabbitmq_mode == "exchange"} class="space-y-4">
              <div>
                <label class="label mb-1">
                  <span class="label-text">
                    Exchange <span class="text-error">*</span>
                  </span>
                </label>
                <input
                  type="text"
                  name="form[rabbitmq_exchange]"
                  value={@form_rabbitmq_exchange}
                  placeholder="my_exchange"
                  class="input input-bordered w-full"
                />
              </div>

              <div>
                <label class="label mb-1">
                  <span class="label-text">
                    Routing Key <span class="text-error">*</span>
                  </span>
                </label>
                <input
                  type="text"
                  name="form[rabbitmq_routing_key]"
                  value={@form_rabbitmq_routing_key}
                  placeholder="my.routing.key"
                  class="input input-bordered w-full"
                />
              </div>
              <p class="text-xs text-base-content/50">
                Message will be published to the exchange with the specified routing key.
              </p>
            </div>
          </div>

          <%!-- Validation errors --%>
          <%= for {_field, error} <- get_form_errors(@delivery_config_form) do %>
            <div class="text-sm text-error bg-error/10 px-3 py-2 rounded">
              <.icon name="hero-exclamation-circle" class="w-4 h-4 inline mr-1" />
              {error}
            </div>
          <% end %>

          <div class="flex gap-2 pt-4 justify-end">
            <button
              type="button"
              class="btn btn-ghost"
              phx-click="cancel_edit_delivery_config"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              Save
            </button>
          </div>
        </.form>
      </div>
    </div>
  </div>
</Layouts.app>
